<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Buscaprop.cl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
      background: #ffffff;
      color: #202124;
    }

    .container {
      max-width: 760px;
      margin: 0 auto;
      padding: 40px 20px 120px;
      text-align: center;
    }

    img {
      width: 300px;
      margin-bottom: 32px;
    }

    #chat {
      text-align: left;
      margin-bottom: 32px;
    }

    .msg {
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .assistant {
      color: #202124;
    }

    .system {
      color: #5f6368;
      font-size: 13px;
    }

    .user {
      text-align: right;
      color: #1a73e8;
    }

    .chip {
      display: inline-block;
      margin: 6px 6px 0 0;
      padding: 6px 12px;
      border-radius: 16px;
      border: 1px solid #dadce0;
      background: #f8f9fa;
      cursor: pointer;
      font-size: 13px;
    }

    .result {
      border-bottom: 1px solid #eee;
      padding-bottom: 12px;
      margin-bottom: 16px;
    }

    input {
      width: 100%;
      max-width: 640px;
      padding: 16px 20px;
      font-size: 16px;
      border-radius: 24px;
      border: 1px solid #dfe1e5;
      outline: none;
    }

    button {
      margin-top: 16px;
      padding: 10px 24px;
      border-radius: 20px;
      border: 1px solid #dadce0;
      background: #f8f9fa;
      cursor: pointer;
    }

    .input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      border-top: 1px solid #e0e0e0;
      padding: 16px;
      display: flex;
      justify-content: center;
      gap: 12px;
    }
  </style>
</head>

<body>

<div class="container">
  <img src="/Logo%20Buscaprop.png" alt="Buscaprop.cl" />

  <div id="chat"></div>
</div>

<div class="input-area">
  <input
    id="userInput"
    type="text"
    placeholder="Busca propiedades en Chile usando lenguaje natural‚Ä¶"
  />
  <button onclick="handleUser()">Enviar</button>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("userInput");

function addMessage(role, text) {
  const div = document.createElement("div");
  div.className = `msg ${role}`;
  div.innerHTML = text;
  chat.appendChild(div);
  window.scrollTo(0, document.body.scrollHeight);
}

function addChips(list) {
  list.forEach(text => {
    const span = document.createElement("span");
    span.className = "chip";
    span.textContent = text;
    span.onclick = () => handleUser(text);
    chat.appendChild(span);
  });
}

async function talkToFrontAI(text) {
  const res = await fetch("/ai-proxy", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text })
  });
  return await res.json(); // { type, message | search_text }
}

async function callBackend(searchText) {
  const res = await fetch(
    "https://superbuscador-api.onrender.com/assistant",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: searchText })
    }
  );
  return await res.json();
}

function renderResults(data) {
  if (data.meta?.interpretation) {
    addMessage("system", `Entend√≠: <strong>${data.meta.interpretation}</strong>`);
  }

  if (data.type === "question") {
    addMessage("assistant", data.message || "¬øPuedes aclarar un poco m√°s?");
    if (data.meta?.suggestions) addChips(data.meta.suggestions);
    return;
  }

  if (!data.results || data.results.length === 0) {
    addMessage("assistant", "No encontr√© resultados con esos criterios.");
    return;
  }

  data.results.slice(0, 10).forEach(p => {
    addMessage("assistant", `
      <div class="result">
        <strong>${p.operacion?.toUpperCase() || "PROPIEDAD"}</strong><br>
        ${p.ubicacion?.comuna || ""} ${p.ubicacion?.sector || ""}<br>
        Dorm: ${p.caracteristicas?.dormitorios ?? "-"}
        ¬∑ Ba√±os: ${p.caracteristicas?.banos ?? "-"}<br>
        <a href="${p.link}" target="_blank">Ver ficha</a>
      </div>
    `);
  });

  if (data.meta?.suggestions) {
    addMessage("system", "Refinar b√∫squeda:");
    addChips(data.meta.suggestions);
  }
}

async function handleUser(forcedText) {
  const text = forcedText || input.value.trim();
  if (!text) return;

  addMessage("user", text);
  input.value = "";

  const ai = await talkToFrontAI(text);

  if (ai.type === "question") {
    addMessage("assistant", ai.message);
    return;
  }

  if (ai.type === "search") {
    addMessage("system", "Buscando propiedades‚Ä¶");
    const data = await callBackend(ai.search_text);
    renderResults(data);
  }
}

// saludo inicial
addMessage(
  "assistant",
  "Hola üëã Soy Buscaprop.cl. Cu√©ntame qu√© tipo de propiedad est√°s buscando."
);
</script>

</body>
</html>
