<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Buscaprop.cl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
      background: #ffffff;
      color: #202124;
    }

    .container {
      max-width: 860px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      text-align: center;
      margin-bottom: 12px;
    }

    header img {
      width: 260px;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 6px 2px;
    }

    .input-bar {
      display: flex;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }

    .input-bar input {
      flex: 1;
      padding: 14px 16px;
      border-radius: 24px;
      border: 1px solid #dfe1e5;
      font-size: 15px;
      outline: none;
    }

    .input-bar button {
      padding: 0 20px;
      border-radius: 24px;
      border: 1px solid #dfe1e5;
      background: #f8f9fa;
      cursor: pointer;
      font-size: 14px;
    }

    .row { margin: 8px 0; }
    .row.user { text-align: right; }

    .bubble {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 16px;
      max-width: 80%;
      line-height: 1.4;
      font-size: 14px;
    }

    .bubble.system { background: #f1f3f4; }
    .bubble.user { background: #e8f0fe; }

    .chips { margin: 10px 0 14px 0; }

    .chips button {
      margin: 4px 6px 0 0;
      padding: 7px 14px;
      border-radius: 18px;
      border: 1px solid #dadce0;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }

    .chips button.primary {
      background: #e8f0fe;
      border-color: #c6dafc;
    }

    .searching {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      margin: 14px 0;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 14px;
      font-size: 13px;
    }

    .searching img { width: 36px; height: 36px; }

    .video-wrapper {
      margin: 16px 0;
      padding: 12px;
      background: #fafafa;
      border: 1px solid #e0e0e0;
      border-radius: 16px;
    }

    .video-wrapper video {
      width: 100%;
      border-radius: 12px;
    }

    .card-wide {
      border-bottom: 1px solid #e6e6e6;
      padding: 10px 6px;
      font-size: 14px;
    }

    .card-wide.highlight {
      background: #f5f9ff;
      border-left: 4px solid #1a73e8;
      padding-left: 10px;
    }

    .card-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-row.secondary {
      margin-top: 4px;
      color: #555;
      font-size: 13px;
    }

    .card-location { font-size: 13px; color: #666; }
    .card-price { font-weight: 600; white-space: nowrap; }
  </style>
</head>

<body>
<div class="container">
  <header>
    <img src="Logo Buscaprop.png" alt="Buscaprop.cl">
  </header>

  <div id="chat"></div>

  <div class="input-bar">
    <input id="userInput" placeholder="Cuéntame qué propiedad buscas…">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
const API_URL = "https://superbuscador-api.onrender.com/assistant";
const chat = document.getElementById("chat");
const input = document.getElementById("userInput");
let searchStepInterval = null;

function addBubble(text, who="system") {
  const row = document.createElement("div");
  row.className = "row " + who;
  const bubble = document.createElement("div");
  bubble.className = "bubble " + who;
  bubble.innerHTML = text;
  row.appendChild(bubble);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

function renderOptions(options) {
  const wrap = document.createElement("div");
  wrap.className = "chips";
  options.forEach(opt => {
    const b = document.createElement("button");
    b.textContent = opt.label;
    if (opt.primary) b.classList.add("primary");
    b.onclick = () => opt.action();
    wrap.appendChild(b);
  });
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
}

function renderSearching() {
  const div = document.createElement("div");
  div.className = "searching";
  div.id = "searching";
  div.innerHTML = `
    <img src="processing.gif">
    <div>
      <strong>Procesando búsqueda</strong><br>
      <span id="step">Interpretando criterios…</span>
    </div>`;
  chat.appendChild(div);

  const steps = [
    "Interpretando criterios…",
    "Normalizando filtros…",
    "Evaluando fuentes de datos…",
    "Filtrando ruido…",
    "Priorizando resultados…"
  ];
  let i = 0;
  searchStepInterval = setInterval(() => {
    document.getElementById("step").textContent = steps[++i % steps.length];
  }, 900);
}

function stopSearching() {
  clearInterval(searchStepInterval);
  document.getElementById("searching")?.remove();
}

function isHighValue(results) {
  return results.some(p =>
    (p.operacion==="venta" && p.precio?.moneda==="UF" && p.precio.valor>=5000) ||
    (p.operacion==="arriendo" && p.precio?.moneda==="CLP" && p.precio.valor>=1200000)
  );
}

function renderIntentQuestion(results) {
  addBubble("Para evaluar si corresponde pasar a una asistencia más completa:<br><br>¿Qué tan decidido estás a concretar esta búsqueda en el corto plazo?");
  renderOptions([
    {label:"Estoy evaluando, sin apuro", action:()=>continueAuto()},
    {label:"Quiero avanzar en los próximos meses", action:()=>continueAuto()},
    {label:"Estoy listo para avanzar pronto", primary:true, action:()=>renderWhatsApp()}
  ]);
}

function continueAuto() {
  addBubble("Perfecto. Continuamos con el proceso automático y seguimiento activo.");
}

function renderWhatsApp() {
  addBubble("Esta búsqueda califica para asistencia directa.");
  addBubble(
    `<a href="https://wa.me/56966370680" target="_blank"
    style="display:inline-block;padding:10px 16px;background:#1a73e8;color:#fff;border-radius:18px;text-decoration:none">
    Continuar por WhatsApp</a>`
  );
}

async function sendMessage() {
  const text = input.value.trim();
  if(!text) return;
  addBubble(text,"user");
  input.value="";
  renderSearching();

  const res = await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({message:text})
  });
  const data = await res.json();
  stopSearching();

  if(data.type==="results") {
    addBubble("Resultados priorizados:");
    data.results.slice(0,5).forEach(p=>{
      addBubble(`${p.tipo||"Propiedad"} · ${p.operacion} · ${p.precio?.valor||"—"} ${p.precio?.moneda||""}`);
    });
    addBubble("Seguimiento activo. Puedes volver por novedades.");
    if(isHighValue(data.results)) renderIntentQuestion(data.results);
  }
}

addBubble("Cuéntame qué propiedad buscas. Tomo el encargo y priorizo opciones relevantes.");
</script>
</body>
</html>
